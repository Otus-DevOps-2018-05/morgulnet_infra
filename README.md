# morgulnet_infra

## Информация о ДЗ Ansible-2
 Использовали плейбуки, хендлеры и шаблоны для конфигурации окружения и деплоя тестового приложения.
 Опробовали подходы один плейбук, один сценарий, один плейбук и много сценариев.
 Применили подход много плейбуков.
 При создлании пакер образа использовали провиженинг с помощью ansible плейбука.

 * Задание со *
  Опробован способы создания динамического инвентори с помощью парсинга вывода gcloud в прошлом ДЗ.
  Реализован динамические инвентори используя gce.py.
  Создан сервисный аккаунт GCP - API и Сервисы - Учетные данные.
  Скачан json ключ. файлы gce.py gce.ini взяты с contrib/inventory/ GitHub.
  Добился вывода ./gce.py --list (Хосты теги и тд).
  Добавил inventory = ./gce.py в ansible.cfg.
  Добавил теги инстансов в плейбуки.
  Пересоздал terraform stage ,проверил что плейбуки правильно отрабатывают.


## Информация о ДЗ Ansible-1
 Установлен ansible, создан файл inventory.
 Проверена работа модулей ping, shell, service и тд
 Убедились что модули absible идемпотентны выполнив команду 2 раза.
 Удалили директорию с приложением и убедились что вывод плейбука отличаеться.
 
 * Задание со *
   Добавлен скрипт inventory.sh который парсит вывод gcloud compute instances list и выводит в формате json
   при выполнение ansible all -i ./inventory.sh -m ping выводит пинг до всех инстансов
    
## Информация о ДЗ Terraform-2
 Определил ресурс файерволла.
 Задано IP для инстанса с приложением в виде ресурса.
 Созданы шаблоны для VM app.json и db.json.
 Созданы правила для файерволла в vpc.tf.
 Разбил конфигурация по файлам.
 Создана директория с модулем db и app и vpc.
 Параметрезированны модули.
 Теперь мы можем задавать диапазоны IP адресов
 для правила файервола при вызове модуля.
 
 * Самостоятельные задания  
  Проверил работу модуля vpc.
  Разделил инфраструктура на Prod и Stage.
  Создал в сервисе Storage.

 * Настроил хранение стейт файла в удаленном бекенде.  

## Задание для подключение к someinternalhost в одну команду

 Добавляем в .ssh/config
 Host bastion
 HostName 35.228.161.210
 Далее подключаемся командой
 ssh -A bastion -fNL 2666:10.142.0.2:22 && ssh 127.0.0.1 -p 2666

 bastion_IP = 35.228.161.210
 someinternalhost_IP = 10.142.0.2

## Информация о ДЗ-4

 testapp_IP = 35.228.217.1
 testapp_port = 9292

 Добавление правила для файрвола
 gcloud compute firewall-rules create "allow-puma" --allow tcp:9292

 Команды gcloud для использования startup.sh
 --metadata-from-file startup-script=startup_script.sh
 --metadata startup-script-url=gs://cloudapp-mo/startup_script.sh

## Информация ДЗ-5

 С помощью packer создан образ reddit-full
 создан скрипт create-reddit-vm.sh

## Информация ДЗ-6

 Основное задание
 Определена input переменная для приватного ключа, использующегося в определении подключения для провижинеров
 Определена input переменная для задания зоны в ресурсе "google_compute_instance" "app".
 Отформатированы все конфигурационные файлы используя команду terraform fmt
 Создан terraform.tfvars.example

* Задание со *
 Добавлены несколько ssh ключей в метаданные проекта
 Вручную добавлен ssh ключ appuser_web
 После выполнения terraform apply ключ appuser_web удаляеться
 т.к декларативное описание состояние системы не включает этот ключ  

* Задание **
 Создал Балансировшик нагрузки ,добавил описание 2 инстанса приложения
 проверил работу балансировшика
 Удалил описание 2 инстанса
 Добавил управление количеством инстансов приложений через переменную count
 Проблемы - у каждого инстанса свои ресурсы - своя база
 Добавил вывод в outputs ip адресов инстансов и балансера  
